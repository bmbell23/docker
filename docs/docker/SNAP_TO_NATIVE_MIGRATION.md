# Docker Migration: Snap to Native

## Problem Statement

Currently running TWO Docker daemons simultaneously:
- **Snap Docker** (PID 1807) - Running ALL containers
- **Native Docker** (PID 69004) - Running but mostly idle

This causes:
- Permission denied errors on `docker restart/kill/stop`
- AppArmor restrictions requiring PID kill workaround
- Potential conflicts between daemons
- Performance overhead

## Solution

Migrate from Snap Docker to native Docker (docker.io package already installed).

## Benefits

✅ **Fixes permission issues permanently** - No more "permission denied" on restart/kill/stop  
✅ **Removes AppArmor restrictions** - Standard Docker behavior  
✅ **Better performance** - Native Docker is faster than Snap  
✅ **Standard installation** - Easier to troubleshoot and maintain  
✅ **No more PID kill workaround needed**

## Pre-Migration Checklist

- [ ] All docker-compose.yml files are committed to git
- [ ] Backup script has been run successfully
- [ ] Migration plan has been reviewed
- [ ] Estimated downtime window scheduled (30-60 minutes)
- [ ] All critical data volumes identified
- [ ] Network configurations documented

## Migration Steps

### Phase 1: Preparation (DO THIS NOW)

1. **Run backup script** (creates full backup of all configs and volumes)
   ```bash
   sudo /home/brandon/projects/docker/scripts/backup-before-migration.sh
   ```

2. **Verify backup completed successfully**
   ```bash
   ls -lh /home/brandon/docker-migration-backup/
   ```

3. **Review inventory** (already generated by backup script)
   ```bash
   cat /home/brandon/docker-migration-backup/inventory.txt
   ```

### Phase 2: Migration (DO THIS WEEKEND)

1. **Stop all containers gracefully**
   ```bash
   sudo /home/brandon/projects/docker/scripts/migrate-snap-to-native.sh
   ```

2. **Script will automatically:**
   - Stop all running containers
   - Export all volumes to backup location
   - Stop Snap Docker daemon
   - Remove Snap Docker
   - Configure native Docker
   - Restart native Docker daemon
   - Recreate all containers from docker-compose files
   - Verify all containers are running

3. **Manual verification after migration:**
   ```bash
   # Check all containers are running
   docker ps
   
   # Test restart command (should work without PID kill!)
   docker restart jellyfin
   
   # Verify Tailscale access
   curl -I http://100.123.154.40:8096
   ```

### Phase 3: Cleanup (After Successful Migration)

1. **Remove backup files** (after confirming everything works for 1 week)
   ```bash
   sudo rm -rf /home/brandon/docker-migration-backup/
   ```

2. **Update documentation** to remove PID kill workaround references

## Rollback Plan

If migration fails:

1. **Reinstall Snap Docker:**
   ```bash
   sudo snap install docker
   ```

2. **Stop native Docker:**
   ```bash
   sudo systemctl stop docker
   sudo systemctl disable docker
   ```

3. **Restore from backup:**
   ```bash
   sudo /home/brandon/projects/docker/scripts/rollback-migration.sh
   ```

## Estimated Downtime

- **Preparation Phase:** 0 minutes (no downtime)
- **Migration Phase:** 30-60 minutes (all containers down)
- **Verification Phase:** 5-10 minutes (containers starting up)

**Total:** ~45-70 minutes

## Critical Services

These services will be down during migration:
- Jellyfin (media streaming)
- Immich (photo backup)
- Outline (wiki)
- All other Docker containers

## Data Safety

✅ **All data is safe** - Volumes are stored on disk, not in containers  
✅ **Backup created** - Full backup before migration  
✅ **Rollback available** - Can restore Snap Docker if needed  
✅ **Git tracked** - All docker-compose files are version controlled

## Post-Migration Verification

After migration, verify:

1. ✅ All containers running: `docker ps | wc -l` should show 28+ containers
2. ✅ Jellyfin accessible via Tailscale: `curl -I http://100.123.154.40:8096`
3. ✅ Docker restart works: `docker restart jellyfin` (no permission denied!)
4. ✅ Docker stop works: `docker stop jellyfin` (no permission denied!)
5. ✅ Docker kill works: `docker kill jellyfin` (no permission denied!)
6. ✅ All volumes intact: `docker volume ls | wc -l` should match pre-migration count
7. ✅ All networks intact: `docker network ls | wc -l` should match pre-migration count
8. ✅ iptables rules applied: `sudo /home/brandon/projects/docker/scripts/fix-all-docker-iptables.sh`

## Notes

- Native Docker is already installed (docker.io package)
- All docker-compose files are already in place
- Migration script handles everything automatically
- Backup script creates point-in-time snapshot for safety
- No data loss expected - volumes persist across Docker installations

## Questions?

Review the migration script before running:
```bash
cat /home/brandon/projects/docker/scripts/migrate-snap-to-native.sh
```

